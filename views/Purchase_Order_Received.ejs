<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <%- include ('header_login.ejs') %>

    <!--비정상 접근 차단-->
    <% if(typeof(pass) === 'undefined') { %>
    <script type="text/javascript">
      alert("비정상적인 접근입니다.");
      window.location.href = "/";
    </script>
    <% } else if(pass == 'NONE') { %>
    <script type="text/javascript">
      alert("로그인이 필요합니다.");
      window.location.href = "/";
    </script>
    <% } else if(typeof(req) === 'undefined') { %>
    <script type="text/javascript">
      alert("비정상적인 접근입니다.");
      window.location.href = "/";
    </script>
    <% } %>

    <style>
      input {
        outline: none;
        border: none;
      }
      li {
        list-style: none;
      }
      img {
        width: 100%;
      }
      .real-upload {
        display: none;
      }
      .upload {
        width: 20px;
        height: 20px;
        background-color: #444444;
      }
      .image-preview {
        gap: 20px;
      }
    </style>
  </head>
  <body>
    <!-- 커스텀 스트립트 -->
    <script type="text/javascript">
      // REQ (요청) 변수들 저장
      const uuid = "<%= req.session.UUID%>";
      const uid = "<%= req.session.UserID%>";
      const uname = "<%= req.session.UserName%>";
      let chat_room = "";
    </script>

    <script type="text/javascript">

      // 웹소켓 클라이언트 접속
      const ws = new WebSocket("ws://localhost:8080");
      ws.onopen = () => {
        console.log("connected at server");
      };
      ws.onclose = () => {
        console.log("disconnected from server");
      };
      ws.onerror = () => {
        console.log("connection error");
      };

      ws.onmessage = (message) => {
        ///웹 소켓에서 메세지가 날아오면 실행되는 함수

        var MSG = JSON.parse(message.data);
        console.log("onmessage :: Chat message Received = " + MSG.msg);
        <% for (var key in req.session.Received_Order) { %>
          if(MSG.chat_room_id == `<%= req.session.Received_Order[key]['TB_CHAT_ROOM_ID'] %>`){
            if (MSG.user_id != uid) {
              newReceiveDiv(chat_tables_<%=key%>, MSG.msg);
            } else {
              //newSendDiv(chat_tables_<%=key%>, MSG.msg);
              console.log("MSG was mine.");
            }
          }
          scrollBottom(`chat_tables_<%=key%>`)
        <% } %>

      };
    </script>

    <script type="text/javascript">
      // 채팅 관련 함수들

      function Enter_Check(div_id, chat_room, key) {
        // 엔터키의 코드는 13
        if (event.keyCode == 13) {
          sendMessage(event, key, uid, uname, chat_room, div_id);
          return;
        }
      }

      function chat_load(div_id, MSG) {
        for (i = 0; i < MSG.length; i++) {
          if (MSG[i].sent_user_id != uid) {
            newReceiveDiv(div_id, MSG[i].message);
          } else {
            newSendDiv(div_id, MSG[i].message);
          }
        }
      }
    </script>

    <div style="height: 50px"></div>
    <table class="table table-hover" id="POtable" style="width: 100vw">
      <thead>
        <tr>
          <th scope="col">제목</th>
          <th scope="col">보낸 업체</th>

          <th scope="col">발주일</th>
          <th scope="col">납품기한</th>
        </tr>
      </thead>
      <tbody>
        <%if (typeof(req.session.Received_Order) !== 'undefined') { for (var key in req.session.Received_Order) { %>
        <tr
          onclick="toggleDiv(myDIV),toggleDiv(myDIV2_<%=key%>),toggleDiv(POtable),toggleDiv(Purchase_Order_<%=key%>), 
            chat_room_<%=key%> = `<%= req.session.Received_Order[key]['TB_CHAT_ROOM_ID'] %>`, scrollBottom(`chat_tables_<%=key%>`);"
        >
          <th scope="row"><%= req.session.Received_Order[key]["Title"] %></th>
          <td><%= req.session.R_CompanyInfo[key]["Comp_NAME"] %></td>
          <td><%= req.session.Received_Order[key]["Order_Date"].split(' ')[0] %></td>
          <td><%= req.session.Received_Order[key]["Delivery_Date"].split(' ')[0] %></td>
        </tr>
        <%}}%>
      </tbody>
    </table>

    <!---------- 채팅창 파트 ------------>
    <div class="d-flex flex-wrap justify-content-center">
      <div id="BIG_DIV" class="col-12 d-flex flex-wrap">
        <div class="col_resize_empty">&nbsp;</div>
        <div class="col_resize" style="text-align: center; background-color: white; display: none" id="myDIV">
          <button
            type="button"
            onclick="
              toggleDiv(myDIV), 
              <% for(var key in req.session.Received_Order) {%>
                Display_none(myDIV2_<%=key%>),
                Display_none(Purchase_Order_<%=key%>),
              <%}%> toggleDiv(POtable)"
            style="float: left; background-color: transparent; border: transparent"
          >
            <i class="bi bi-x-lg"></i>
          </button>
          <button onclick="window.open('/PO_edit','_blank')" style="font-size: 2vmin; justify-items: end" class="btn btn-light">수정</button>
          <div><%- include ('Purchase_Order_Received_form.ejs') %></div>
        </div>
        <div class="col_resize_empty_2">&nbsp;</div>

        <% for (var key in req.session.Received_Order) { %>
        <div class="col_resize_chat content" id="myDIV2_<%=key%>" style="text-align: center; font-size: 1.75vw; display: none">
          <div id="CHAT" style="background-color: #d2e9f2; border: var(--bs-border-color-translucent) 1px solid"><%=key%></div>
          <div
            id="chat_tables_<%=key%>"
            class="col-12 test"
            style="
              word-break: break-all;
              border: var(--bs-border-color-translucent) 1px solid;
              background-color: #d2e9f2;
              min-height: 600px;
              max-height: 1100px;
              height: calc(82vh - 150px);
              overflow-y: scroll;
            "
          ></div>

          <div id="BUTTON_DIV" class="d-flex">
            <input
              type="text"
              rows="3"
              id="txt_on_<%=key%>"
              style="width: 100%; border: transparent; outline: none"
              onkeydown="Enter_Check(chat_tables_<%=key%>, chat_room_<%=key%>, <%=key%>), scrollBottom(`chat_tables_<%=key%>`)"
            />
            <button
              type="button"
              onclick="sendMessage(undefined, <%=key%>, uid, uname, chat_room_<%=key%>, chat_tables_<%=key%>), scrollBottom(`chat_tables_<%=key%>`)"
              class="btn btn-secondary"
              style="border: var(--bs-border-color-translucent) 1px solid; border-radius: 0"
            >
              <i class="bi bi-send"></i>
            </button>
          </div>
        </div>
        <div class="col_resize_empty">&nbsp;</div>
      </div>
    </div>

    <script>
      // 첫 채팅 메세지 로딩
      var MSG = JSON.parse(`<%- req.session.R_Chatting[key] %>`);
      chat_load(chat_tables_<%=key%>, MSG);
    </script>
    <%}%>
  </body>
</html>
